@{
    ViewBag.Title = "List";
    Layout = "~/Views/_Layouts/AdminLayout.cshtml";
}

<table class="menus_list tbl_list">
    <tr>
        <th>코드</th>
        <th>상위코드</th>
        <th>메뉴이름</th>
        <th>URL</th>
        <th>사용여부</th>
        <th>권한</th>
        <th>순서</th>
        <th>메뉴설명</th>
        <th>수정날짜</th>
        <th>만든날짜</th>
    </tr>

    @foreach (var item in @Model)
    {
        <tr data-menu-code="@item.Code">
            <td>@item.Code</td>
            <td>@item.ParentCode</td>
            <td>@item.Name</td>
            <td>@item.Url</td>
            <td>@item.Enabled</td>
            <td>@item.Role</td>
            <td>@item.Ordering</td>
            <td>@item.Comment</td>
            <td>@item.Modified</td>
            <td>@item.Created</td>
        </tr>
    }
</table>

<table class="tbl_menu_info tbl_form">
    <tr>
        <th class="th_label">메뉴이름</th>
        <td class="td_body"><input type="text" name="menuName" id="menu-name" class="txt_box" /></td class="td_body">
        <th class="th_label">상위메뉴</th>
        <td class="td_body">
            <select name="menuParent" id="menu-parent" class="sel_box">
                <option value="0">-----------</option>
            </select>
        </td class="td_body">
        <th class="th_label">URL</th>
        <td class="td_body"><input type="text" name="menuName" id="menu-url" class="txt_box" /></td class="td_body">
    </tr>
    <tr>
        <th class="th_label">사용여부</th>
        <td class="td_body">
            <select name="menuEnabled" id="menu-enabled" class="sel_box">
                <option value="Y">사용</option>
                <option value="N">사용안함</option>
            </select>
        </td class="td_body">
        <th class="th_label">사용권한</th>
        <td class="td_body">
            <select name="menuRole" id="menu-role" class="sel_box">
                <option value="Open">개방</option>
                <option value="Closed">관리자전용</option>
            </select>
        </td class="td_body">
        <th class="th_label">순서</th>
        <td class="td_body"><input type="text" name="menuName" id="menu-ordering" class="txt_box" /></td class="td_body">
    </tr>
    <tr>
        <th class="th_label">설명</th>
        <td class="td_body" colspan="5"><input type="text" name="menuComment" id="menu-comment" class="txt_box menu_comment" /></td class="td_body">
    </tr>
</table>

<div class="btn_group">
    <input type="button" value="취소" id="btn-cancel" class="btn_set" />
    <input type="button" value="수정" id="btn-update" class="btn_set" />
    <input type="button" value="추가" id="btn-add" class="btn_set" />
</div>

<script>
    $(document).ready(function () {
        var code;
        $('.tbl_list tr').click(function () {
            code = $(this).data('menu-code');

            $.ajax({
                url: '/Admin/GetMenu',
                data: { code: code },
                success: function (data) {
                    $('#menu-name').val(data.Name);
                    $('#menu-code').val(data.Code);
                    GetParentName(data.ParentCode);
                    $('#parent-code').val(data.ParentCode);

                    if (data.Url == '') {
                        $('#menu-url').val('없음');
                    }
                    else {
                        $('#menu-url').val(data.Url);
                    }

                    $('#menu-comment').val(data.Comment);
                    $('#menu-role').val(data.Role);
                    $('#menu-enabled').val(data.Enabled);
                },
                error: function (xhr, error, status) {
                    alert(xhr + ":" + error + ":" + status + ":" + typeof (code));
                }
            });

            return false;
        });

        $('#btn-cancel').click(function () {
            EmptyForms();
        });

        $('#btn-update').click(function () {
            SubmitForms('update');
        })
        $('#btn-add').click(function () {
            SubmitForms();
        })
    });

    function GetParentName(parentCode) {
        if ('0' == parentCode) {
            $('#parent-name').val('최상위');
        }
        else {
            $.ajax({
                url: '/Admin/GetMenu',
                data: { code: parentCode },
                success: function (parent) {
                    $('#parent-name').val(parent.Name);
                }
            });
        }
    }

    function EmptyForms() {
        // 취소 버튼 클릭 시 텍스트박스 클리어
        $('#menus-form input').each(function () {
            $(this).val('');
        })
    }

    function SubmitForms(btnGb) {
        var value = [];
        var json = {};

        $('#menus-form input').each(function (i, v) {
            value[i] = $(this).val();
        })

        json = {
            Name: value[0],
            Code: value[1],
            ParentCode: value[3],
            Url: value[4],
            Role: value[5],
            Enabled: value[6]
        }

        if (btnGb == 'update') {
            $.ajax({
                url: '/Admin/UpdateMenu',
                data: json,
                success: function (data) {
                    alert("메뉴수정이 완료되었습니다.");
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
        else {
            $.ajax({
                url: '/Admin/AddMenu',
                data: json,
                success: function (data) {
                    alert("메뉴추가가 완료되었습니다.");
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }

    }
</script>
